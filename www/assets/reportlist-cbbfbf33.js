var T=Object.defineProperty;var F=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,O=Object.prototype.propertyIsEnumerable;var B=(e,n,l)=>n in e?T(e,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[n]=l,k=(e,n)=>{for(var l in n||(n={}))q.call(n,l)&&B(e,l,n[l]);if(F)for(var l of F(n))O.call(n,l)&&B(e,l,n[l]);return e};import{r as _,U as S,_ as A,b as V,u as X,d as Y,R as I}from"./index.1a2bb961.js";import{d as U,i as w,r as H,c as v,Y as $,o as J,E as c,m as h,q as g,y as p,G as d,F as M,A as L,z as E,I as W,C as P}from"../vendors/element-plus-6f9977bb.js";function z(e){return _.post(S.REPORT.queryPurchasedMaterial,e)}function j(e){return _.post(S.REPORT.queryReportByDepartment,e)}function G(){return _.get(S.DEPARTMENT.queryDepartment)}const K=U({setup(){V();const e=X(),n=Y(),l=[{label:"\u90E8\u95E8",prop:"departmentName"},{label:"\u7269\u6599\u540D\u79F0",prop:"materialName"}],R=w("exportXLSX"),y=()=>{t.loading=!0;const a=t.subDepartments,{dateRange:i}=W(t.searchParam),[s,u]=i.map(r=>r.substring(0,7)),o=I(s,u);t.months=o,t.headersConfig=l.concat(o.map(r=>({label:`${r}\u91C7\u8D2D\u91CF`,prop:r,width:90}))),z({BeginDate:s,EndDate:u,departments:a}).then(r=>{t.hospitalCodesOptions=r.materials.map(b=>({label:b.MaterialName,value:b.MaterialHospitalCode}));const f={BeginDate:s,EndDate:u,departments:[],hospitalCodes:t.searchParam.hospitalCodes};return j(f).then(b=>{N(b.reports)})}).finally(()=>{t.loading=!1})},N=a=>{t.tableData=a.map(i=>{const{MaterialName:s,HospitalCode:u,YearMonth:o,TotalAmount:m,departmentDetails:r,unit:f}=i;return{hospitalCode:u,materialName:s,unit:f,departmentName:r[0].DepartmentName,departmentId:r[0].DepartmentId,[o]:m}})},t=H({loading:!1,MinUnitTypeMap:v(()=>n.getters.MinUnitTypeMap),MaterialTypeMap:v(()=>n.getters.MaterialTypeMap),searchParam:{searchWord:"",hospitalCodes:[],dateRange:JSON.parse(localStorage.getItem("dateRange"))||["2021-11-01","2022-03-01"]},months:[],hospitalCodesOptions:[],searchMoreParam:{department:""},pagination:{currentPage:1,total:0,pageSize:30},headersConfig:[],tableData:[],multipleSelection:[],subDepartments:[]}),C=a=>{a&&(t.pagination.currentPage=1),y()},D={calcHeaderWidth:w("calcHeaderMinWidth"),handleChangeMultiple(a){t.multipleSelection=a},handlePaginationChange(){C(!1)},handleSearch(){C(!0)},handleSearchMoreParamChange(a){t.searchMoreParam=a,C(!0)},handleShowLineChart(){const a=t.multipleSelection,i=a.every(u=>u.departmentName===a[0].departmentName),s=a.every(u=>u.hospitalCode===a[0].hospitalCode);if(i||s)return localStorage.setItem("dateRange",JSON.stringify(t.searchParam.dateRange)),e.push({name:"reportlinechart",params:{unitName:s?a[0].unit:"",sameDepartment:i,sameMaterial:s,months:JSON.stringify(t.months),tableData:JSON.stringify(a)}});$({title:"\u9519\u8BEF\u63D0\u793A",message:"\u53EA\u80FD\u9009\u5219\u76F8\u540C\u90E8\u95E8\u7684\u4E0D\u540C\u7269\u6599\u6216\u8005\u4E0D\u540C\u90E8\u95E8\u7684\u76F8\u540C\u7269\u6599\u8FDB\u884C\u67E5\u770B",type:"error",duration:0})},handleExportXLSX(){R(t.headersConfig,t.tableData,"\u62A5\u8868","\u62A5\u8868\u8BE6\u60C5")}};return J(()=>{Promise.all([G().then(a=>{t.subDepartments=a.departments.map(i=>i.id)})]).then(()=>{y()})}),k({state:t},D)}}),Q={class:"date-box"},Z=P("\u67E5\u8BE2"),x=P("\u67E5\u770B\u6298\u7EBF\u56FE"),ee=P("\u4E0B\u8F7D\u62A5\u8868"),ae={key:0},te={key:1};function ne(e,n,l,R,y,N){const t=c("el-date-picker"),C=c("el-option"),D=c("el-select"),a=c("el-button"),i=c("styled-search"),s=c("el-table-column"),u=c("styled-table");return h(),g(M,null,[p(i,{"hide-search-more":"","only-department":"",onChooseSearchMoreParam:e.handleSearchMoreParamChange},{"styled-search-left":d(()=>[p("div",Q,[p(t,{modelValue:e.state.searchParam.dateRange,"onUpdate:modelValue":n[1]||(n[1]=o=>e.state.searchParam.dateRange=o),"unlink-panels":"",type:"monthrange","value-format":"YYYY-MM-DD","range-separator":"\u81F3","start-placeholder":"\u5F00\u59CB\u65E5\u671F","end-placeholder":"\u7ED3\u675F\u65E5\u671F"},null,8,["modelValue"])]),p(D,{modelValue:e.state.searchParam.hospitalCodes,"onUpdate:modelValue":n[2]||(n[2]=o=>e.state.searchParam.hospitalCodes=o),placeholder:"\u8BF7\u9009\u62E9\u7269\u6599\u9662\u5185\u7801",clearable:"",multiple:"","collapse-tags":""},{default:d(()=>[(h(!0),g(M,null,L(e.state.hospitalCodesOptions,(o,m)=>(h(),g(C,{key:m,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),p(a,{type:"primary",class:"search",onClick:e.handleSearch},{default:d(()=>[Z]),_:1},8,["onClick"])]),"styled-search-right":d(()=>[p(a,{type:"primary",class:"search",disabled:e.state.multipleSelection.length<1,onClick:e.handleShowLineChart},{default:d(()=>[x]),_:1},8,["disabled","onClick"]),p(a,{type:"success",class:"export",disabled:e.state.tableData.length===0,onClick:e.handleExportXLSX},{default:d(()=>[ee]),_:1},8,["disabled","onClick"])]),_:1},8,["onChooseSearchMoreParam"]),p(u,{multiple:"",loading:e.state.loading,data:e.state.tableData,onChangeMultiple:e.handleChangeMultiple},{"table-columns":d(()=>[(h(!0),g(M,null,L(e.state.headersConfig,(o,m)=>(h(),g(s,{"show-overflow-tooltip":"",key:m,prop:o.prop,label:o.label,"min-width":e.calcHeaderWidth(o,m)},{header:d(r=>[p("span",null,E(r.column.label),1)]),default:d(r=>[["departmentName","materialName"].includes(r.column.property)?(h(),g("span",ae,E(r.row[o.prop]),1)):(h(),g("span",te,E(r.row[o.prop]&&r.row[o.prop]+r.row.unit),1))]),_:2},1032,["prop","label","min-width"]))),128))]),_:1},8,["loading","data","onChangeMultiple"])],64)}var se=A(K,[["render",ne]]);export{se as default};
